{% extends "base.html" %}

{% block title %}Aylık Satış Raporu{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        border-radius: 10px;
        border: none;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .export-buttons .btn {
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .table-wrapper {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Başlık -->
    <div class="report-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-graph-up-arrow"></i> Aylık Satış Raporu
                </h2>
                <p class="mb-0 opacity-75">Son 12 aylık satış performansı</p>
            </div>
            <div>
                <a href="{{ url_for('raporlar.index') }}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Raporlar
                </a>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="baslangic" name="baslangic" 
                           value="{{ baslangic_tarih }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="bitis" name="bitis" 
                           value="{{ bitis_tarih }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Fatura Türü</label>
                    <select class="form-select" id="fatura_turu" name="fatura_turu">
                        <option value="">Tümü</option>
                        <option value="SATIS" selected>Satış</option>
                        <option value="ALIS">Alış</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Filtrele
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Özet Kartlar -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Toplam Satış</h6>
                            <h3 class="mb-0" id="toplamSatis">₺0</h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Fatura Sayısı</h6>
                            <h3 class="mb-0" id="faturaSayisi">0</h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-file-text"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Ortalama Fatura</h6>
                            <h3 class="mb-0" id="ortalamaFatura">₺0</h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-calculator"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">En İyi Ay</h6>
                            <h3 class="mb-0" id="enIyiAy">-</h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-trophy"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="row g-4 mb-4">
        <!-- Çizgi Grafik -->
        <div class="col-lg-8">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-graph-up"></i> Aylık Satış Trendi
                </h5>
                <canvas id="salesLineChart"></canvas>
            </div>
        </div>
        
        <!-- Pasta Grafik -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-pie-chart"></i> Aylık Dağılım
                </h5>
                <canvas id="salesPieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Export Butonları -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="mb-3">
                <i class="bi bi-download"></i> Raporu İndir
            </h5>
            <div class="export-buttons">
                <button class="btn btn-success" onclick="exportReport('excel')">
                    <i class="bi bi-file-earmark-excel"></i> Excel İndir
                </button>
                <button class="btn btn-danger" onclick="exportReport('pdf')">
                    <i class="bi bi-file-earmark-pdf"></i> PDF İndir
                </button>
                <button class="btn btn-primary" onclick="exportReport('csv')">
                    <i class="bi bi-file-earmark-text"></i> CSV İndir
                </button>
                <button class="btn btn-info" onclick="window.print()">
                    <i class="bi bi-printer"></i> Yazdır
                </button>
            </div>
        </div>
    </div>

    <!-- Detaylı Tablo -->
    <div class="table-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Detaylı Veriler
            </h5>
            <input type="text" class="form-control w-25" id="tableSearch" 
                   placeholder="Tabloda ara...">
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover table-striped" id="salesTable">
                <thead class="table-dark">
                    <tr>
                        <th>Yıl</th>
                        <th>Ay</th>
                        <th class="text-end">Fatura Sayısı</th>
                        <th class="text-end">Toplam Tutar (₺)</th>
                        <th class="text-end">Ortalama Tutar (₺)</th>
                        <th class="text-center">Değişim</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
                <tfoot class="table-secondary fw-bold">
                    <tr>
                        <td colspan="2">GENEL TOPLAM</td>
                        <td class="text-end" id="totalFaturalar">0</td>
                        <td class="text-end" id="totalTutar">₺0</td>
                        <td class="text-end" id="totalOrtalama">₺0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="mt-3 text-muted">Rapor hazırlanıyor...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Global değişkenler
let salesData = {{ data|tojson|safe }};
let lineChart, pieChart;

// Ay isimleri
const aylar = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
               'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    processData();
    createCharts();
    fillTable();
    updateStats();
});

// Veriyi işle
function processData() {
    // Ay numarasını isme çevir
    salesData = salesData.map(item => ({
        ...item,
        ay_adi: aylar[item.ay - 1],
        degisim: 0  // Sonra hesaplanacak
    }));
    
    // Değişim yüzdesini hesapla (bir önceki aya göre)
    for (let i = 1; i < salesData.length; i++) {
        const onceki = salesData[i-1].toplam_tutar;
        const simdi = salesData[i].toplam_tutar;
        salesData[i].degisim = onceki > 0 ? ((simdi - onceki) / onceki * 100).toFixed(1) : 0;
    }
}

// Grafikleri oluştur
function createCharts() {
    // Çizgi Grafik
    const lineCtx = document.getElementById('salesLineChart').getContext('2d');
    lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: salesData.map(d => `${d.ay_adi} ${d.yil}`),
            datasets: [{
                label: 'Satış Tutarı (₺)',
                data: salesData.map(d => d.toplam_tutar),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Tutar: ₺' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₺' + value.toLocaleString('tr-TR');
                        }
                    }
                }
            }
        }
    });
    
    // Pasta Grafik (Son 6 ay)
    const pieCtx = document.getElementById('salesPieChart').getContext('2d');
    const son6Ay = salesData.slice(-6);
    
    pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: son6Ay.map(d => `${d.ay_adi} ${d.yil}`),
            datasets: [{
                data: son6Ay.map(d => d.toplam_tutar),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ₺' + context.parsed.toLocaleString('tr-TR') + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Tabloyu doldur
function fillTable() {
    const tbody = document.getElementById('salesTableBody');
    tbody.innerHTML = '';
    
    salesData.forEach((row, index) => {
        const tr = document.createElement('tr');
        
        const degisimClass = row.degisim > 0 ? 'text-success' : (row.degisim < 0 ? 'text-danger' : 'text-muted');
        const degisimIcon = row.degisim > 0 ? '▲' : (row.degisim < 0 ? '▼' : '■');
        
        tr.innerHTML = `
            <td>${row.yil}</td>
            <td><strong>${row.ay_adi}</strong></td>
            <td class="text-end">${row.fatura_sayisi}</td>
            <td class="text-end">₺${parseFloat(row.toplam_tutar).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
            <td class="text-end">₺${parseFloat(row.ortalama_tutar).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
            <td class="text-center ${degisimClass}">
                ${index > 0 ? `${degisimIcon} ${Math.abs(row.degisim)}%` : '-'}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

// İstatistikleri güncelle
function updateStats() {
    const toplamSatis = salesData.reduce((sum, row) => sum + parseFloat(row.toplam_tutar), 0);
    const toplamFatura = salesData.reduce((sum, row) => sum + parseInt(row.fatura_sayisi), 0);
    const ortalamaFatura = toplamFatura > 0 ? toplamSatis / toplamFatura : 0;
    
    // En iyi ayı bul
    const enIyiAyData = salesData.reduce((max, row) => 
        parseFloat(row.toplam_tutar) > parseFloat(max.toplam_tutar) ? row : max
    , salesData[0]);
    
    document.getElementById('toplamSatis').textContent = '₺' + toplamSatis.toLocaleString('tr-TR', {minimumFractionDigits: 2});
    document.getElementById('faturaSayisi').textContent = toplamFatura.toLocaleString('tr-TR');
    document.getElementById('ortalamaFatura').textContent = '₺' + ortalamaFatura.toLocaleString('tr-TR', {minimumFractionDigits: 2});
    document.getElementById('enIyiAy').textContent = `${enIyiAyData.ay_adi} ${enIyiAyData.yil}`;
    
    // Footer toplamları
    document.getElementById('totalFaturalar').textContent = toplamFatura.toLocaleString('tr-TR');
    document.getElementById('totalTutar').textContent = '₺' + toplamSatis.toLocaleString('tr-TR', {minimumFractionDigits: 2});
    document.getElementById('totalOrtalama').textContent = '₺' + ortalamaFatura.toLocaleString('tr-TR', {minimumFractionDigits: 2});
}

// Tablo arama
document.getElementById('tableSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#salesTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Export fonksiyonu
function exportReport(format) {
    const params = new URLSearchParams({
        tip: 'aylik_satis',
        baslangic: document.getElementById('baslangic').value,
        bitis: document.getElementById('bitis').value,
        fatura_turu: document.getElementById('fatura_turu').value
    });
    
    window.location.href = `/raporlar/export/${format}?${params.toString()}`;
}

// Form submit
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    document.getElementById('loadingSpinner').style.display = 'block';
    
    // Formu submit et (sayfa yenilenecek)
    this.submit();
});

// Yazdırma CSS
window.addEventListener('beforeprint', function() {
    document.querySelectorAll('.btn, .export-buttons, .report-header a').forEach(el => {
        el.style.display = 'none';
    });
});

window.addEventListener('afterprint', function() {
    document.querySelectorAll('.btn, .export-buttons, .report-header a').forEach(el => {
        el.style.display = '';
    });
});
</script>
{% endblock %}