{% extends "base.html" %}

{% block title %}Rapor Tasarƒ±mcƒ±{% endblock %}

{% block extra_css %}
<style>
    /* ===================================== */
    /* GENEL LAYOUT */
    /* ===================================== */
    .designer-container {
        display: grid;
        grid-template-columns: 300px 1fr 350px;
        gap: 20px;
        height: calc(100vh - 150px);
        overflow: hidden;
    }
    
    .designer-panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .panel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        font-weight: bold;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .panel-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    
    /* ===================================== */
    /* SOL PANEL - MODEL & FIELDS */
    /* ===================================== */
    .field-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .field-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .field-item:hover {
        background: #e7f3ff;
        border-color: #007bff;
        transform: translateX(5px);
    }
    
    .field-item.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }
    
    .field-icon {
        font-size: 1.2rem;
        color: #667eea;
    }
    
    .field-type-badge {
        background: #667eea;
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }
    
    /* ===================================== */
    /* ORTA PANEL - REPORT BUILDER */
    /* ===================================== */
    .drop-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 30px;
        min-height: 150px;
        background: #f7fafc;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    
    .drop-zone.drag-over {
        border-color: #667eea;
        background: #eef2ff;
        transform: scale(1.02);
    }
    
    .drop-zone-empty {
        text-align: center;
        color: #a0aec0;
        padding: 40px;
    }
    
    .drop-zone-empty i {
        font-size: 3rem;
        margin-bottom: 10px;
        display: block;
    }
    
    .selected-field {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
    }
    
    .selected-field:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .selected-field .field-name {
        flex: 1;
        font-weight: 500;
    }
    
    .selected-field .field-actions {
        display: flex;
        gap: 5px;
    }
    
    .btn-field-action {
        background: none;
        border: none;
        color: #718096;
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s;
    }
    
    .btn-field-action:hover {
        color: #667eea;
    }
    
    .btn-field-remove:hover {
        color: #e53e3e;
    }
    
    /* ===================================== */
    /* Fƒ∞LTRE BUILDER */
    /* ===================================== */
    .filter-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: 1fr 120px 1fr 40px;
        gap: 10px;
        align-items: center;
    }
    
    .filter-connector {
        text-align: center;
        font-weight: bold;
        color: #667eea;
        padding: 10px 0;
    }
    
    /* ===================================== */
    /* SAƒû PANEL - √ñNƒ∞ZLEME */
    /* ===================================== */
    .preview-table {
        width: 100%;
        font-size: 0.85rem;
        margin-top: 20px;
    }
    
    .preview-table th {
        background: #f7fafc;
        padding: 8px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .preview-table td {
        padding: 8px;
        border-bottom: 1px solid #f1f1f1;
    }
    
    .preview-empty {
        text-align: center;
        padding: 40px;
        color: #a0aec0;
    }
    
    .chart-preview {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }
    
    /* ===================================== */
    /* TABS */
    /* ===================================== */
    .nav-tabs-custom {
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 20px;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        color: #718096;
        padding: 10px 20px;
        transition: all 0.2s;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: #667eea;
    }
    
    .nav-tabs-custom .nav-link.active {
        color: #667eea;
        border-bottom: 3px solid #667eea;
        font-weight: 600;
    }
    
    /* ===================================== */
    /* BUTTONS */
    /* ===================================== */
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    
    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* ===================================== */
    /* LOADING */
    /* ===================================== */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
    }
    
    /* ===================================== */
    /* RESPONSIVE */
    /* ===================================== */
    @media (max-width: 1400px) {
        .designer-container {
            grid-template-columns: 250px 1fr;
        }
        
        .designer-panel.preview-panel {
            display: none;
        }
    }
    
    @media (max-width: 768px) {
        .designer-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .designer-panel {
            height: auto;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Ba≈ülƒ±k -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1">
                <i class="bi bi-magic"></i> Rapor Tasarƒ±mcƒ±
                <span class="badge bg-success">No-Code</span>
            </h3>
            <p class="text-muted mb-0">Kendi raporunuzu s√ºr√ºkle-bƒ±rak ile olu≈üturun</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="openSavedReports()">
                <i class="bi bi-folder-open"></i> Kaydedilenler
            </button>
            <button class="btn btn-gradient" onclick="saveReport()">
                <i class="bi bi-save"></i> Raporu Kaydet
            </button>
        </div>
    </div>

    <!-- Designer Grid -->
    <div class="designer-container">
        <!-- ===================================== -->
        <!-- SOL PANEL: MODEL & FIELDS -->
        <!-- ===================================== -->
        <div class="designer-panel">
            <div class="panel-header">
                <i class="bi bi-database me-2"></i> Veri Kaynaƒüƒ±
            </div>
            <div class="panel-body">
                <!-- Model Se√ßimi -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Model</label>
                    <select class="form-select" id="modelSelect" onchange="loadModelFields()">
                        <option value="Fatura" selected>Faturalar</option>
                        <option value="CariHesap">Cari Hesaplar</option>
                        <option value="StokKart">Stok Kartlarƒ±</option>
                        <option value="CariHareket">Cari Hareketler</option>
                    </select>
                </div>

                <!-- Alanlar -->
                <div>
                    <label class="form-label fw-bold">Alanlar</label>
                    <p class="small text-muted">S√ºr√ºkle ‚Üí Rapor alanƒ±na bƒ±rak</p>
                    
                    <ul class="field-list" id="fieldList">
                        <!-- JavaScript ile doldurulacak -->
                    </ul>
                </div>

                <!-- Hƒ±zlƒ± ≈ûablonlar -->
                <div class="mt-4">
                    <label class="form-label fw-bold">Hƒ±zlƒ± ≈ûablonlar</label>
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadTemplate('aylik_satis')">
                            <i class="bi bi-graph-up"></i> Aylƒ±k Satƒ±≈ü
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="loadTemplate('cari_bakiye')">
                            <i class="bi bi-people"></i> Cari Bakiye
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="loadTemplate('stok_durum')">
                            <i class="bi bi-box"></i> Stok Durum
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================== -->
        <!-- ORTA PANEL: REPORT BUILDER -->
        <!-- ===================================== -->
        <div class="designer-panel">
            <div class="panel-header">
                <div>
                    <i class="bi bi-puzzle me-2"></i> Rapor Yapƒ±landƒ±rmasƒ±
                </div>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="runReport()">
                        <i class="bi bi-play-fill"></i> √áalƒ±≈ütƒ±r
                    </button>
                    <button class="btn btn-light btn-sm" onclick="clearReport()">
                        <i class="bi bi-trash"></i> Temizle
                    </button>
                </div>
            </div>
            <div class="panel-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#tabFields">
                            <i class="bi bi-list-ul"></i> Alanlar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tabFilters">
                            <i class="bi bi-funnel"></i> Filtreler
                            <span class="badge bg-primary" id="filterCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tabGrouping">
                            <i class="bi bi-collection"></i> Gruplama
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tabChart">
                            <i class="bi bi-bar-chart"></i> Grafik
                        </a>
                    </li>
                </ul>

                <!-- Tab ƒ∞√ßerikleri -->
                <div class="tab-content mt-3">
                    <!-- ===================================== -->
                    <!-- TAB 1: ALANLAR -->
                    <!-- ===================================== -->
                    <div class="tab-pane fade show active" id="tabFields">
                        <div class="drop-zone" id="fieldsDropZone" 
                             ondrop="dropField(event)" 
                             ondragover="allowDrop(event)"
                             ondragleave="dragLeave(event)">
                            <div class="drop-zone-empty">
                                <i class="bi bi-arrow-down-circle"></i>
                                <p>Soldan alan s√ºr√ºkle ve buraya bƒ±rak</p>
                            </div>
                        </div>

                        <!-- Se√ßili Alanlar -->
                        <div id="selectedFieldsList"></div>
                    </div>

                    <!-- ===================================== -->
                    <!-- TAB 2: Fƒ∞LTRELER -->
                    <!-- ===================================== -->
                    <div class="tab-pane fade" id="tabFilters">
                        <button class="btn btn-sm btn-primary mb-3" onclick="addFilter()">
                            <i class="bi bi-plus-circle"></i> Filtre Ekle
                        </button>

                        <div id="filtersList"></div>
                    </div>

                    <!-- ===================================== -->
                    <!-- TAB 3: GRUPLAMA -->
                    <!-- ===================================== -->
                    <div class="tab-pane fade" id="tabGrouping">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Gruplama Alanƒ±</label>
                            <select class="form-select" id="groupByField">
                                <option value="">Gruplanmamƒ±≈ü</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Toplama Fonksiyonu</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="aggFunction">
                                        <option value="sum">TOPLAM (SUM)</option>
                                        <option value="avg">ORTALAMA (AVG)</option>
                                        <option value="count">SAYMA (COUNT)</option>
                                        <option value="min">Mƒ∞Nƒ∞MUM (MIN)</option>
                                        <option value="max">MAKSƒ∞MUM (MAX)</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="aggField">
                                        <option value="">Alan se√ß...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>ƒ∞pucu:</strong> Gruplama yaparken toplama fonksiyonu kullanmalƒ±sƒ±nƒ±z.
                        </div>
                    </div>

                    <!-- ===================================== -->
                    <!-- TAB 4: GRAFƒ∞K -->
                    <!-- ===================================== -->
                    <div class="tab-pane fade" id="tabChart">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="chartEnabled">
                            <label class="form-check-label fw-bold" for="chartEnabled">
                                Grafik G√∂ster
                            </label>
                        </div>

                        <div id="chartConfig" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Grafik Tipi</label>
                                <select class="form-select" id="chartType">
                                    <option value="line">√áizgi Grafik</option>
                                    <option value="bar">S√ºtun Grafik</option>
                                    <option value="pie">Pasta Grafik</option>
                                    <option value="doughnut">Donut Grafik</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">X Ekseni (Yatay)</label>
                                <select class="form-select" id="chartXAxis">
                                    <option value="">Alan se√ß...</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Y Ekseni (Dikey)</label>
                                <select class="form-select" id="chartYAxis">
                                    <option value="">Alan se√ß...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================== -->
        <!-- SAƒû PANEL: √ñNƒ∞ZLEME -->
        <!-- ===================================== -->
        <div class="designer-panel preview-panel">
            <div class="panel-header">
                <i class="bi bi-eye me-2"></i> √ñnizleme
            </div>
            <div class="panel-body">
                <!-- ƒ∞statistikler -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body p-2 text-center">
                                <small>Kayƒ±t</small>
                                <h5 class="mb-0" id="previewRowCount">0</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white">
                            <div class="card-body p-2 text-center">
                                <small>Alan</small>
                                <h5 class="mb-0" id="previewFieldCount">0</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grafik √ñnizleme -->
                <div id="chartPreview" class="chart-preview" style="display: none;">
                    <canvas id="previewChart"></canvas>
                </div>

                <!-- Tablo √ñnizleme -->
                <div id="tablePreview">
                    <div class="preview-empty">
                        <i class="bi bi-table"></i>
                        <p>Raporu √ßalƒ±≈ütƒ±rƒ±n</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5>Rapor Olu≈üturuluyor...</h5>
        <p class="text-muted">Veriler analiz ediliyor</p>
    </div>
</div>

<!-- Kaydetme Modal -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-save"></i> Raporu Kaydet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Rapor Adƒ±</label>
                    <input type="text" class="form-control" id="reportName" placeholder="√ñrn: Aylƒ±k Satƒ±≈ü Raporu">
                </div>
                <div class="mb-3">
                    <label class="form-label">A√ßƒ±klama</label>
                    <textarea class="form-control" id="reportDescription" rows="3" placeholder="Rapor hakkƒ±nda kƒ±sa a√ßƒ±klama..."></textarea>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="reportPublic">
                    <label class="form-check-label" for="reportPublic">
                        Diƒüer kullanƒ±cƒ±larla payla≈ü
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" onclick="confirmSave()">
                    <i class="bi bi-check-circle"></i> Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ===================================== 
// GLOBAL DEƒûƒ∞≈ûKENLER
// =====================================
let currentModel = 'Fatura';
let selectedFields = [];
let filters = [];
let reportData = [];
let previewChart = null;

// Model field definitions
const modelFields = {
    'Fatura': [
        {name: 'id', label: 'ID', type: 'number'},
        {name: 'belge_no', label: 'Belge No', type: 'text'},
        {name: 'tarih', label: 'Tarih', type: 'date'},
        {name: 'fatura_turu', label: 'Fatura T√ºr√º', type: 'text'},
        {name: 'genel_toplam', label: 'Genel Toplam', type: 'currency'},
        {name: 'kdv_toplam', label: 'KDV Toplam', type: 'currency'},
        {name: 'cari_id', label: 'Cari ID', type: 'number'},
        {name: 'durum', label: 'Durum', type: 'text'}
    ],
    'CariHesap': [
        {name: 'id', label: 'ID', type: 'number'},
        {name: 'kod', label: 'Kod', type: 'text'},
        {name: 'unvan', label: '√únvan', type: 'text'},
        {name: 'vergi_no', label: 'Vergi No', type: 'text'},
        {name: 'telefon', label: 'Telefon', type: 'text'},
        {name: 'borc_bakiye', label: 'Bor√ß Bakiye', type: 'currency'},
        {name: 'alacak_bakiye', label: 'Alacak Bakiye', type: 'currency'},
        {name: 'aktif', label: 'Aktif', type: 'boolean'}
    ]
};

// Operator definitions
const operators = [
    {value: 'equals', label: 'E≈üittir (=)'},
    {value: 'not_equals', label: 'E≈üit Deƒüil (!=)'},
    {value: 'greater_than', label: 'B√ºy√ºkt√ºr (>)'},
    {value: 'less_than', label: 'K√º√ß√ºkt√ºr (<)'},
    {value: 'greater_or_equal', label: 'B√ºy√ºk E≈üit (>=)'},
    {value: 'less_or_equal', label: 'K√º√ß√ºk E≈üit (<=)'},
    {value: 'contains', label: 'ƒ∞√ßerir (LIKE)'},
    {value: 'starts_with', label: 'ƒ∞le Ba≈ülar'},
    {value: 'ends_with', label: 'ƒ∞le Biter'},
    {value: 'between', label: 'Arasƒ±nda'},
    {value: 'in', label: 'ƒ∞√ßinde (IN)'},
    {value: 'is_null', label: 'Bo≈ü'},
    {value: 'is_not_null', label: 'Dolu'}
];

// ===================================== 
// SAYFA Y√úKLEME
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    loadModelFields();
    
    // ‚úÖ Eƒüer loaded_report varsa (URL'den geliyorsa)
    {% if loaded_report %}
    console.log('üì• Saved report y√ºkleniyor:', {{ loaded_report|tojson|safe }});
    loadSavedReport({{ loaded_report|tojson|safe }});
    {% endif %}
    
    // Chart enabled checkbox
    document.getElementById('chartEnabled').addEventListener('change', function() {
        document.getElementById('chartConfig').style.display = this.checked ? 'block' : 'none';
    });
});

// ===================================== 
// KAYITLI RAPOR Y√úKLEME
// =====================================
function loadSavedReport(report) {
    console.log('üìÇ Rapor y√ºkleniyor:', report);
    
    try {
        // 1. Model se√ß
        if (report.model_name) {
            document.getElementById('modelSelect').value = report.model_name;
            currentModel = report.model_name;
            loadModelFields();
        }
        
        // 2. Config parse
        const config = report.config;
        
        if (!config) {
            console.error('‚ùå Config bulunamadƒ±!');
            return;
        }
        
        console.log('üìã Config:', config);
        
        // 3. Alanlarƒ± ekle
        if (config.fields && config.fields.length > 0) {
            selectedFields = config.fields.map(f => ({
                ...f,
                visible: f.visible !== false
            }));
            renderSelectedFields();
            console.log(`‚úÖ ${selectedFields.length} alan y√ºklendi`);
        }
        
        // 4. Filtreleri ekle
        if (config.filters && config.filters.length > 0) {
            filters = config.filters;
            renderFilters();
            console.log(`‚úÖ ${filters.length} filtre y√ºklendi`);
        }
        
        // 5. Gruplama
        if (config.group_by && config.group_by.length > 0) {
            document.getElementById('groupByField').value = config.group_by[0];
        }
        
        // 6. Agregasyon
        if (config.aggregations && config.aggregations.length > 0) {
            const agg = config.aggregations[0];
            document.getElementById('aggFunction').value = agg.function || 'sum';
            document.getElementById('aggField').value = agg.field || '';
        }
        
        // 7. Grafik
        if (config.chart && config.chart.enabled) {
            document.getElementById('chartEnabled').checked = true;
            document.getElementById('chartConfig').style.display = 'block';
            document.getElementById('chartType').value = config.chart.type || 'line';
            document.getElementById('chartXAxis').value = config.chart.x_axis || '';
            document.getElementById('chartYAxis').value = config.chart.y_axis || '';
        }
        
        // 8. Rapor adƒ±nƒ± modal'a yaz
        if (report.name) {
            document.getElementById('reportName').value = report.name;
        }
        if (report.description) {
            document.getElementById('reportDescription').value = report.description;
        }
        if (report.is_public) {
            document.getElementById('reportPublic').checked = true;
        }
        
        console.log('‚úÖ Rapor ba≈üarƒ±yla y√ºklendi!');
        
        // 9. Otomatik √ßalƒ±≈ütƒ±r (opsiyonel)
        setTimeout(() => {
            console.log('üöÄ Rapor otomatik √ßalƒ±≈ütƒ±rƒ±lƒ±yor...');
            runReport();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Rapor y√ºkleme hatasƒ±:', error);
        alert('Rapor y√ºklenirken hata olu≈ütu: ' + error.message);
    }
}

// ===================================== 
// MODEL FIELD Y√úKLEME
// =====================================
function loadModelFields() {
    currentModel = document.getElementById('modelSelect').value;
    const fields = modelFields[currentModel] || [];
    
    const fieldList = document.getElementById('fieldList');
    fieldList.innerHTML = '';
    
    fields.forEach(field => {
        const li = document.createElement('li');
        li.className = 'field-item';
        li.draggable = true;
        li.dataset.field = JSON.stringify(field);
        
        li.innerHTML = `
            <i class="bi ${getFieldIcon(field.type)} field-icon"></i>
            <span>${field.label}</span>
            <span class="field-type-badge">${field.type}</span>
        `;
        
        li.addEventListener('dragstart', dragStart);
        li.addEventListener('dragend', dragEnd);
        
        fieldList.appendChild(li);
    });
    
    // Group by ve chart axis select'lerini g√ºncelle
    updateGroupByOptions();
}

function getFieldIcon(type) {
    const icons = {
        'text': 'bi-fonts',
        'number': 'bi-123',
        'currency': 'bi-currency-dollar',
        'date': 'bi-calendar',
        'boolean': 'bi-toggle-on'
    };
    return icons[type] || 'bi-question-circle';
}

// ===================================== 
// DRAG & DROP
// =====================================
function dragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', e.target.dataset.field);
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropField(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const fieldData = JSON.parse(e.dataTransfer.getData('text/plain'));
    
    // Zaten eklenmi≈üse tekrar ekleme
    if (selectedFields.find(f => f.name === fieldData.name)) {
        alert('Bu alan zaten eklenmi≈ü!');
        return;
    }
    
    selectedFields.push({...fieldData, visible: true});
    renderSelectedFields();
    updateGroupByOptions();
}

// ===================================== 
// SE√áƒ∞Lƒ∞ ALANLARI RENDER ET
// =====================================
function renderSelectedFields() {
    const container = document.getElementById('selectedFieldsList');
    const dropZone = document.getElementById('fieldsDropZone');
    
    if (selectedFields.length === 0) {
        dropZone.querySelector('.drop-zone-empty').style.display = 'block';
        container.innerHTML = '';
        return;
    }
    
    dropZone.querySelector('.drop-zone-empty').style.display = 'none';
    
    container.innerHTML = selectedFields.map((field, index) => `
        <div class="selected-field">
            <i class="bi bi-grip-vertical" style="cursor: move;"></i>
            <span class="field-name">${field.label}</span>
            <div class="field-actions">
                <button class="btn-field-action" onclick="toggleFieldVisibility(${index})" title="G√∂r√ºn√ºrl√ºk">
                    <i class="bi ${field.visible ? 'bi-eye' : 'bi-eye-slash'}"></i>
                </button>
                <button class="btn-field-action btn-field-remove" onclick="removeField(${index})" title="Kaldƒ±r">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    document.getElementById('previewFieldCount').textContent = selectedFields.length;
}

function toggleFieldVisibility(index) {
    selectedFields[index].visible = !selectedFields[index].visible;
    renderSelectedFields();
}

function removeField(index) {
    selectedFields.splice(index, 1);
    renderSelectedFields();
    updateGroupByOptions();
}

// ===================================== 
// Fƒ∞LTRE Y√ñNETƒ∞Mƒ∞
// =====================================
function addFilter() {
    const filterId = filters.length;
    
    filters.push({
        id: filterId,
        field: '',
        operator: 'equals',
        value: ''
    });
    
    renderFilters();
}

function renderFilters() {
    const container = document.getElementById('filtersList');
    const fields = modelFields[currentModel] || [];
    
    if (filters.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Hen√ºz filtre eklenmedi</p>';
        document.getElementById('filterCount').textContent = '0';
        return;
    }
    
    container.innerHTML = filters.map((filter, index) => `
        <div class="filter-item">
            ${index > 0 ? '<div class="filter-connector">VE</div>' : ''}
            <div class="filter-row">
                <select class="form-select form-select-sm" onchange="updateFilter(${index}, 'field', this.value)">
                    <option value="">Alan se√ß...</option>
                    ${fields.map(f => `<option value="${f.name}" ${filter.field === f.name ? 'selected' : ''}>${f.label}</option>`).join('')}
                </select>
                
                <select class="form-select form-select-sm" onchange="updateFilter(${index}, 'operator', this.value)">
                    ${operators.map(op => `<option value="${op.value}" ${filter.operator === op.value ? 'selected' : ''}>${op.label}</option>`).join('')}
                </select>
                
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Deƒüer" 
                       value="${filter.value}"
                       onchange="updateFilter(${index}, 'value', this.value)">
                
                <button class="btn btn-sm btn-outline-danger" onclick="removeFilter(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    document.getElementById('filterCount').textContent = filters.length;
}

function updateFilter(index, key, value) {
    filters[index][key] = value;
}

function removeFilter(index) {
    filters.splice(index, 1);
    renderFilters();
}

// ===================================== 
// GRUPLAMA & TOPLAMA
// =====================================
function updateGroupByOptions() {
    const groupBySelect = document.getElementById('groupByField');
    const aggFieldSelect = document.getElementById('aggField');
    const chartXAxis = document.getElementById('chartXAxis');
    const chartYAxis = document.getElementById('chartYAxis');
    
    const options = selectedFields.map(f => 
        `<option value="${f.name}">${f.label}</option>`
    ).join('');
    
    [groupBySelect, aggFieldSelect, chartXAxis, chartYAxis].forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Se√ß...</option>' + options;
            select.value = currentValue;
        }
    });
}

// ===================================== 
// RAPOR √áALI≈ûTIRMA
// =====================================
function runReport() {
    if (selectedFields.length === 0) {
        alert('L√ºtfen en az bir alan se√ßin!');
        return;
    }
    
    const config = buildReportConfig();
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    document.getElementById('loadingOverlay').classList.add('active');
    
    fetch('/rapor/api/rapor-calistir', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').classList.remove('active');
        
        if (data.success) {
            reportData = data.data;
            renderPreview(data);
            
            // ‚úÖ YENƒ∞: Tam ekran √∂nizleme butonu g√∂ster
            if (data.data.length > 0) {
                const previewBtn = `
                    <button class="btn btn-primary mt-3" onclick="openFullPreview('${config.model_name}')">
                        <i class="bi bi-eye"></i> Tam Ekran √ñnizleme (A4)
                    </button>
                `;
                document.getElementById('tablePreview').insertAdjacentHTML('afterend', previewBtn);
            }
        } else {
            alert('Hata: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').classList.remove('active');
        alert('Rapor √ßalƒ±≈ütƒ±rƒ±lamadƒ±: ' + error.message);
    });
}

// ‚úÖ YENƒ∞: Tam ekran √∂nizleme
function openFullPreview(modelName) {
    window.open(`/rapor/onizleme/${modelName}`, '_blank');
}


function buildReportConfig() {
    const config = {
        name: document.getElementById('reportName')?.value || 'Rapor',
        model_name: currentModel,  // Global deƒüi≈üken
        fields: [],
        filters: [],
        group_by: [],
        aggregations: [],
        order_by: [],
        limit: null,
        chart: null
    };
    
    // ===================================
    // 1. ALANLAR (fields)
    // ===================================
    // Sadece g√∂r√ºn√ºr alanlarƒ± ekle
    config.fields = selectedFields.filter(f => f.visible).map(f => ({
        name: f.name,
        label: f.label,
        type: f.type,
        visible: true
    }));
    
    console.log('üìã Fields:', config.fields);
    
    // ===================================
    // 2. Fƒ∞LTRELER (filters)
    // ===================================
    // Sadece dolu filtreleri ekle
    config.filters = filters.filter(f => f.field && f.value).map(f => ({
        field: f.field,
        operator: f.operator,
        value: f.value
    }));
    
    console.log('üîç Filters:', config.filters);
    
    // ===================================
    // 3. GRUPLAMA (group_by)
    // ===================================
    const groupBy = document.getElementById('groupByField')?.value;
    if (groupBy) {
        config.group_by.push(groupBy);
        
        // Agregasyon varsa ekle
        const aggFunc = document.getElementById('aggFunction')?.value;
        const aggField = document.getElementById('aggField')?.value;
        
        if (aggField && aggFunc) {
            config.aggregations.push({
                function: aggFunc,
                field: aggField,
                alias: `${aggFunc}_${aggField}`
            });
        }
    }
    
    console.log('üìä Group by:', config.group_by);
    console.log('üßÆ Aggregations:', config.aggregations);
    
    // ===================================
    // 4. SIRALAMA (order_by)
    // ===================================
    // ƒ∞steƒüe baƒülƒ±: ƒ∞lk alana g√∂re sƒ±rala
    if (config.fields.length > 0) {
        config.order_by.push({
            field: config.fields[0].name,
            direction: 'ASC'
        });
    }
    
    console.log('üî¢ Order by:', config.order_by);
    
    // ===================================
    // 5. GRAFƒ∞K (chart)
    // ===================================
    if (document.getElementById('chartEnabled')?.checked) {
        const chartType = document.getElementById('chartType')?.value;
        const chartXAxis = document.getElementById('chartXAxis')?.value;
        const chartYAxis = document.getElementById('chartYAxis')?.value;
        
        if (chartType && chartXAxis && chartYAxis) {
            config.chart = {
                enabled: true,
                type: chartType,
                x_axis: chartXAxis,
                y_axis: chartYAxis,
                label: `${chartYAxis} Grafiƒüi`
            };
        }
    }
    
    console.log('üìà Chart:', config.chart);
    
    // ===================================
    // 6. EXPORT (opsiyonel)
    // ===================================
    config.export = {
        formats: ['excel', 'pdf', 'csv'],
        filename: config.name.toLowerCase().replace(/\s+/g, '_')
    };
    
    console.log('üíæ Final config:', config);
    
    return config;
}

// ===================================== 
// √ñNƒ∞ZLEME RENDER
// =====================================
function renderPreview(data) {
    console.log('üñºÔ∏è renderPreview() ba≈ülatƒ±ldƒ±');
    console.log('üìä Data:', data);
    
    const tableContainer = document.getElementById('tablePreview');
    
    if (!tableContainer) {
        console.error('‚ùå tablePreview elementi bulunamadƒ±!');
        return;
    }
    
    // ƒ∞statistikleri g√ºncelle
    document.getElementById('previewRowCount').textContent = data.row_count || 0;
    document.getElementById('previewFieldCount').textContent = selectedFields.length;
    
    if (!data.data || data.data.length === 0) {
        tableContainer.innerHTML = '<div class="preview-empty"><i class="bi bi-inbox"></i><p>Sonu√ß bulunamadƒ±</p></div>';
        return;
    }
    
    console.log('üìã Kayƒ±t sayƒ±sƒ±:', data.data.length);
    console.log('üìã ƒ∞lk kayƒ±t:', data.data[0]);
    
    // Sadece g√∂r√ºn√ºr alanlarƒ± kullan
    const visibleFields = selectedFields.filter(f => f.visible);
    console.log('üëÅÔ∏è G√∂r√ºn√ºr alan sayƒ±sƒ±:', visibleFields.length);
    
    if (visibleFields.length === 0) {
        tableContainer.innerHTML = '<div class="preview-empty"><i class="bi bi-eye-slash"></i><p>G√∂r√ºn√ºr alan yok</p></div>';
        return;
    }
    
    // Tablo olu≈ütur
    let tableHTML = '<table class="preview-table table table-sm table-hover">';
    
    // Ba≈ülƒ±k satƒ±rƒ±
    tableHTML += '<thead><tr>';
    visibleFields.forEach(field => {
        tableHTML += `<th>${field.label}</th>`;
    });
    tableHTML += '</tr></thead>';
    
    // Veri satƒ±rlarƒ± (ilk 10 kayƒ±t)
    tableHTML += '<tbody>';
    const displayData = data.data.slice(0, 10);
    
    displayData.forEach(row => {
        tableHTML += '<tr>';
        visibleFields.forEach(field => {
            let value = row[field.name];
            
            // Null/undefined kontrol√º
            if (value === null || value === undefined || value === '') {
                value = '-';
            }
            
            // Boolean formatƒ±
            if (typeof value === 'boolean') {
                value = value ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>';
            }
            
            // Tarih formatƒ±
            if (field.type === 'date' && value !== '-') {
                try {
                    const date = new Date(value);
                    value = date.toLocaleDateString('tr-TR');
                } catch (e) {
                    // Hatalƒ± tarih formatƒ±
                }
            }
            
            // Para formatƒ±
            if (field.type === 'currency' && value !== '-') {
                try {
                    value = parseFloat(value).toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }) + ' ‚Ç∫';
                } catch (e) {
                    // Hatalƒ± sayƒ± formatƒ±
                }
            }
            
            tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
    });
    
    tableHTML += '</tbody></table>';
    
    // Toplam kayƒ±t bilgisi
    if (data.row_count > 10) {
        tableHTML += `<p class="text-muted text-center small mt-2">ƒ∞lk 10 kayƒ±t g√∂steriliyor (Toplam: ${data.row_count})</p>`;
    }
    
    // ‚úÖ Tam ekran √∂nizleme butonu
    if (data.data.length > 0 && data.model_name) {
        tableHTML += `
            <div class="text-center mt-3">
                <button class="btn btn-primary" onclick="openFullPreview('${data.model_name}')">
                    <i class="bi bi-eye"></i> Tam Ekran √ñnizleme (A4)
                </button>
            </div>
        `;
    }
    
    tableContainer.innerHTML = tableHTML;
    
    console.log('‚úÖ Tablo render edildi');
    
    // Grafik render
    if (data.chart) {
        renderChart(data.chart);
    } else {
        const chartPreview = document.getElementById('chartPreview');
        if (chartPreview) {
            chartPreview.style.display = 'none';
        }
    }
}

// ===================================== 
// TAM EKRAN √ñNƒ∞ZLEME
// =====================================
function openFullPreview(modelName) {
    console.log('üñºÔ∏è Tam ekran √∂nizleme a√ßƒ±lƒ±yor:', modelName);
    window.open(`/rapor/onizleme/${modelName}`, '_blank');
}

// ===================================== 
// GRAFƒ∞K RENDER
// =====================================
function renderChart(chartConfig) {
    const container = document.getElementById('chartPreview');
    const canvas = document.getElementById('previewChart');
    
    container.style.display = 'block';
    
    // Eski grafik varsa temizle
    if (previewChart) {
        previewChart.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    previewChart = new Chart(ctx, chartConfig);
}

// ===================================== 
// RAPOR KAYDETME
// =====================================
function saveReport() {
    if (selectedFields.length === 0) {
        alert('L√ºtfen en az bir alan se√ßin!');
        return;
    }
    
    // Modal a√ß
    const modal = new bootstrap.Modal(document.getElementById('saveModal'));
    modal.show();
}

function confirmSave() {
    const name = document.getElementById('reportName').value.trim();
    
    if (!name) {
        alert('‚ùå L√ºtfen rapor adƒ± girin!');
        return;
    }
    
    // ===================================
    // 1. CONFIG OLU≈ûTUR
    // ===================================
    const reportConfig = buildReportConfig();
    
    console.log('üìã Report Config:', reportConfig);
    
    // ===================================
    // 2. VALIDASYON
    // ===================================
    if (!reportConfig.model_name) {
        alert('‚ùå Model se√ßilmemi≈ü!');
        return;
    }
    
    if (!reportConfig.fields || reportConfig.fields.length === 0) {
        alert('‚ùå En az bir alan se√ßmelisiniz!');
        return;
    }
    
    // ===================================
    // 3. BACKEND VERƒ∞Sƒ∞Nƒ∞ HAZIRLA
    // ===================================
    // ‚úÖ Config ayrƒ± bir obje olarak g√∂nderilmeli!
    const saveData = {
        name: name,  // ‚úÖ Config dƒ±≈üƒ±nda
        description: document.getElementById('reportDescription').value || '',  // ‚úÖ Config dƒ±≈üƒ±nda
        model_name: reportConfig.model_name,  // ‚úÖ Config'ten al
        is_public: document.getElementById('reportPublic').checked,  // ‚úÖ Config dƒ±≈üƒ±nda
        config: {  // ‚úÖ Config objesi
            fields: reportConfig.fields,
            filters: reportConfig.filters,
            group_by: reportConfig.group_by,
            aggregations: reportConfig.aggregations,
            order_by: reportConfig.order_by,
            limit: reportConfig.limit,
            chart: reportConfig.chart,
            export: reportConfig.export
        }
    };
    
    console.log('üì§ Backend\'e g√∂nderilecek:', saveData);
    console.log('üì§ Config var mƒ±?', !!saveData.config);
    console.log('üì§ Config.fields:', saveData.config?.fields?.length || 0);
    
    // ===================================
    // 4. CSRF TOKEN
    // ===================================
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    if (!csrfToken) {
        alert('‚ùå CSRF token bulunamadƒ±! Sayfayƒ± yenileyin.');
        return;
    }
    
    // ===================================
    // 5. LOADING
    // ===================================
    const saveButton = document.querySelector('#saveModal .btn-primary');
    const originalText = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
    
    // ===================================
    // 6. FETCH
    // ===================================
    fetch('/rapor/api/rapor-kaydet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(saveData)
    })
    .then(response => {
        console.log('üì• Response status:', response.status);
        console.log('üì• Content-Type:', response.headers.get('Content-Type'));
        
        const contentType = response.headers.get('Content-Type');
        if (contentType && contentType.includes('text/html')) {
            throw new Error('Backend HTML d√∂nd√ºrd√º!');
        }
        
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.message || `HTTP ${response.status}`);
            }
            return data;
        });
    })
    .then(data => {
        console.log('‚úÖ Success:', data);
        
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('saveModal')).hide();
            alert(`‚úÖ ${data.message}`);
            window.location.href = '/rapor/kaydedilenler';
        } else {
            alert('‚ùå Hata: ' + data.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
        
        alert('‚ùå Kaydetme hatasƒ±:\n' + error.message);
    });
}

// ===================================== 
// TEMƒ∞ZLEME
// =====================================
function clearReport() {
    if (!confirm('T√ºm yapƒ±landƒ±rmayƒ± temizlemek istediƒüinizden emin misiniz?')) {
        return;
    }
    
    selectedFields = [];
    filters = [];
    reportData = [];
    
    renderSelectedFields();
    renderFilters();
    
    document.getElementById('tablePreview').innerHTML = '<div class="preview-empty"><i class="bi bi-table"></i><p>Raporu √ßalƒ±≈ütƒ±rƒ±n</p></div>';
    document.getElementById('chartPreview').style.display = 'none';
    
    if (previewChart) {
        previewChart.destroy();
        previewChart = null;
    }
}

// ===================================== 
// ≈ûABLON Y√úKLEME
// =====================================
function loadTemplate(templateName) {
    // Burada hazƒ±r ≈üablonlar y√ºklenebilir
    alert('≈ûablon y√ºkleme √∂zelliƒüi yakƒ±nda eklenecek!');
}

function openSavedReports() {
    window.location.href = '/rapor/kaydedilenler';
}
</script>
{% endblock %}