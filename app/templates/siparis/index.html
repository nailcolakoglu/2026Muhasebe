{% extends "base.html" %}
{% block title %}Siparişler{% endblock %}
{% block content %}
<div id="flash-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-cart4 me-2"></i>Sipariş Yönetimi</h3>
        <a href="{{ url_for('siparis.ekle') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i> Yeni Sipariş
        </a>
    </div>
    {{ grid.render('siparis.index')|safe }}
</div>
{% endblock %} 
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1.Flash Mesaj Fonksiyonu ---
    function showFlash(type, message) {
        const container = document.getElementById('flash-container');
        if (!container) return;
        
        const id = 'toast-' + Date.now();
        // Hata durumunda 'danger', başarıda 'success' class'ı
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const title = type === 'success' ? 'Başarılı!' : 'Hata!';
        
        const html = `
            <div id="${id}" class="alert ${alertClass} alert-dismissible fade show shadow-lg" role="alert" style="min-width: 300px;">
                <strong>${title}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        container.innerHTML += html;
        
        // 5 saniye sonra kaldır
        setTimeout(() => {
            const el = document.getElementById(id);
            if(el) { 
                el.classList.remove('show'); 
                setTimeout(() => el.remove(), 500); 
            }
        }, 5000);
    }

    // --- 2.ONAYLA BUTONU (Düzeltilmiş Seçici) ---
    // Artık data-action="approve" olan BUTONLARI yakalıyoruz
    $(document).on('click', 'button[data-action="approve"]', function(e) {
        e.preventDefault();
        var $btn = $(this);
        var id = $btn.data('id'); // Butondaki ID'yi al (Örn: 7)
        
        // URL'i manuel oluşturuyoruz çünkü butonda href yok
        var url = '/siparis/onayla/' + id;
        
        if(!id) {
            console.error("Butonda ID bulunamadı!");
            return;
        }

        if(!confirm("Bu siparişi onaylamak istiyor musunuz?")) return;

        // Butonu kilitle ve ikon değiştir
        var originalContent = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

        // POST İsteği
        $.post(url)
            .done(function(res) {
                if(res.success) {
                    showFlash('success', res.message);
                    
                    // Satırın rengini değiştir veya güncelle
                    var $row = $btn.closest('tr');
                    $row.addClass('table-success'); // Görsel geri bildirim
                    
                    // Butonu kaldır veya pasif yap
                    $btn.remove(); 
                    
                    // Opsiyonel: Sayfayı yenile (Durumun 'Onaylandı' yazması için)
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showFlash('danger', res.message);
                    $btn.prop('disabled', false).html(originalContent);
                }
            })
            .fail(function(err) {
                var msg = "Sunucu hatası oluştu.";
                if(err.responseJSON && err.responseJSON.message) {
                    msg = err.responseJSON.message;
                } else if (err.responseText) {
                    // Flask hata sayfasını konsola bas (Debug için)
                    console.error("Hata Detayı:", err.responseText);
                }
                
                showFlash('danger', msg);
                $btn.prop('disabled', false).html(originalContent);
            });
    });

    // --- 3.FATURALA BUTONU İÇİN DİNLEYİCİ (YENİ) ---
    $(document).on('click', 'button[data-action="convert"]', function(e) {
        e.preventDefault();
        
        var $btn = $(this);
        var id = $btn.data('id');
        var url = '/siparis/faturala/' + id; // Python rotası
        
        if(!confirm("Bu sipariş için Satış Faturası oluşturulacak.Onaylıyor musunuz?")) return;

        // Görsel Geri Bildirim (Loading)
        var originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

        $.post(url)
            .done(function(res) {
                if(res.success) {
                    showFlash('success', res.message + " Yönlendiriliyor...");
                    
                    // 1.5 Saniye sonra Fatura Ekranına Git
                    setTimeout(() => {
                        window.location.href = res.redirect; 
                    }, 1500);
                } else {
                    showFlash('danger', res.message);
                    $btn.prop('disabled', false).html(originalHtml);
                }
            })
            .fail(function(err) {
                var msg = "Sunucu hatası oluştu.";
                if(err.responseJSON && err.responseJSON.message) msg = err.responseJSON.message;
                showFlash('danger', msg);
                $btn.prop('disabled', false).html(originalHtml);
            });
    });

    // Sayfa yüklendiğinde "Faturalandı" yazan satırlardaki işlem butonlarını gizle/pasif yap
document.addEventListener("DOMContentLoaded", function() {
    $('table tbody tr').each(function() {
        var durumText = $(this).find('td[data-field="durum"]').text().trim().toUpperCase();
        
        if (durumText.includes('FATURALANDI') || durumText.includes('TAMAMLANDI')) {
            // Butonları bul ve pasif yap veya gizle
            var $actions = $(this).find('td:last-child');
            $actions.find('button, a').addClass('disabled').attr('disabled', true).css('opacity', '0.3');
            $actions.find('button[data-action="convert"]').remove(); // Faturala butonunu tamamen sil
        }
    });
});
});
</script>
{% endblock %}