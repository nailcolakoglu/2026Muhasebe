{% extends "base.html" %}

{% block title %}Banka Ekstre AktarÄ±mÄ±{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0">
                <i class="bi bi-file-earmark-spreadsheet-fill text-success me-2"></i>
                Banka Ekstre AktarÄ±mÄ± (Import)
            </h3>
            <p class="text-muted">Excel ekstrenizi yÃ¼kleyin, sistem otomatik eÅŸleÅŸtirsin.</p>
        </div>
        <div>
            <a href="/banka-import/sablonlar" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-gear"></i> Åžablon AyarlarÄ±
            </a>
            <a href="/banka-import/kurallar" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-robot"></i> EÅŸleÅŸtirme KurallarÄ±
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <form id="uploadForm" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="row g-3 align-items-end">
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Hangi Bankaya Ä°ÅŸlenecek?</label>
                        <select name="banka_id" class="form-select" required>
                            {% for b in bankalar %}
                            <option value="{{ b.id }}">{{ b.banka_adi }} - {{ b.ad }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Hangi Excel Åžablonu?</label>
                        <select name="sablon_id" class="form-select" required>
                            {% for s in sablonlar %}
                            <option value="{{ s.id }}">{{ s.banka_adi }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Excel DosyasÄ± SeÃ§</label>
                        <input type="file" name="file" class="form-control" accept=".xlsx, .xls" required>
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100" id="btnPreview">
                            <i class="bi bi-eye"></i> Ã–nizle
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="previewSection" class="card shadow-sm border-0 d-none">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">AktarÄ±lacak Ä°ÅŸlemler (<span id="rowCount">0</span>)</h6>
            <button onclick="aktarimiTamamla()" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> SeÃ§ilenleri Aktar
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0" id="importTable">
                    <thead class="table-light">
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" checked></th>
                            <th>Tarih</th>
                            <th>AÃ§Ä±klama</th>
                            <th>Belge No</th>
                            <th class="text-end">Tutar</th>
                            <th>YÃ¶n</th>
                            <th>Hesap / EÅŸleÅŸme Durumu</th>
                            <th>Komisyon (POS)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    let formData = new FormData(this);
    let btn = document.getElementById('btnPreview');
    
    // Butonu Kilitle
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analiz Ediliyor...';

    fetch('/banka-import/yukle', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        // EÄŸer sunucu hata verdiyse (500, 404 vb.)
        if (!response.ok) {
            // Hata metnini (HTML veya Text) al
            const text = await response.text();
            throw new Error(`Sunucu HatasÄ± (${response.status}): ${text}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert("Ä°ÅŸlem HatasÄ±: " + data.error);
        } else {
            renderTable(data.data, data.file_hash);
        }
        resetButton();
    })
    .catch(err => {
        console.error("DetaylÄ± Hata:", err);
        // HatanÄ±n ilk 200 karakterini gÃ¶ster (Ã‡ok uzun HTML basmasÄ±n)
        let msg = err.message.substring(0, 300);
        alert("Bir hata oluÅŸtu!\n\nDetay:\n" + msg);
        resetButton();
    });

    function resetButton() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-eye"></i> Ã–nizle';
    }
});

let globalHash = "";

function renderTable(rows, hash) {
    globalHash = hash;
    let tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    document.getElementById('rowCount').innerText = rows.length;
    document.getElementById('previewSection').classList.remove('d-none');

    rows.forEach((row, index) => {
        let matchStatus = '';
        let targetSelect = '';
        let rowClass = '';
        
        // --- 1.EÅžLEÅžME DURUMU VE KURAL KAYDETME BUTONU ---
        if (row.oneri.bulundu) {
            rowClass = 'table-success';
            let kaynakBadge = '';
            let saveRuleCheckbox = '';

            // Kaynak GÃ¶sterimi
            if(row.oneri.kaynak === 'kural') {
                kaynakBadge = '<span class="badge bg-primary ms-1">Kural</span>';
            }
            else if(row.oneri.kaynak === 'vkn_eslesmesi' || row.oneri.kaynak === 'isim_eslesmesi') {
                // EÄŸer Ä°sim veya VKN ile bulunduysa "SarÄ±" badge ve "Kural Kaydet" kutusu koy
                kaynakBadge = '<span class="badge bg-warning text-dark ms-1">Ä°sim/VKN</span>';
                
                // ðŸ‘‡ YENÄ°: Kural Kaydetme SeÃ§eneÄŸi (VarsayÄ±lan SeÃ§ili)
                saveRuleCheckbox = `
                    <div class="form-check form-check-inline ms-2" title="Ä°ÅŸlem aktarÄ±lÄ±rken bu eÅŸleÅŸme KURAL olarak kaydedilsin mi?">
                        <input class="form-check-input save-rule-check" type="checkbox" checked id="ruleCheck${index}">
                        <label class="form-check-label small text-muted" for="ruleCheck${index}">
                            <i class="bi bi-save"></i> Ã–ÄŸren
                        </label>
                    </div>
                `;
            }

            matchStatus = `<span class="badge bg-success"><i class="bi bi-check-all"></i> ${row.oneri.display}</span> ${kaynakBadge}`;
            
            targetSelect = `
                <input type="hidden" class="target-id" value="${row.oneri.target_id}">
                <input type="hidden" class="target-type" value="${row.oneri.hedef_turu}">
                
                <input type="hidden" class="match-source" value="${row.oneri.kaynak}">
                <input type="hidden" class="match-key" value="${row.oneri.kural_anahtar}">
                
                ${matchStatus}
                ${saveRuleCheckbox} `;
        } else {
            rowClass = 'table-warning';
            targetSelect = `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> EÅŸleÅŸmedi</span>`;
        }

        // POS Bilgisi
        let posInfo = '-';
        if (row.oneri.is_pos) {
            posInfo = `
                <div class="small text-danger">Kom: ${formatMoney(row.oneri.komisyon)}</div>
                <div class="small text-muted">BrÃ¼t: ${formatMoney(row.oneri.brut_tutar)}</div>
            `;
        }

        let html = `
            <tr class="${rowClass}">
                <td><input type="checkbox" class="row-check" checked data-index="${index}"></td>
                <td>${formatDate(row.tarih)}</td>
                <td class="small text-truncate" style="max-width: 250px;" title="${row.aciklama}">${row.aciklama}</td>
                <td>${row.belge_no}</td>
                <td class="text-end fw-bold ${row.yon === 'giris' ? 'text-success' : 'text-danger'}">
                    ${formatMoney(row.tutar)}
                </td>
                <td>${row.yon === 'giris' ? 'GÄ°RÄ°Åž' : 'Ã‡IKIÅž'}</td>
                <td>${targetSelect}</td>
                <td>${posInfo}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', html);
        
        // Data'yÄ± sakla
        tbody.lastElementChild.dataset.rowData = JSON.stringify(row);
    });
}

function aktarimiTamamla() {
    let selectedRows = [];
    let bankaId = document.querySelector('select[name="banka_id"]').value;

    // 1.DOM'daki Gizli Input'tan CSRF Token'Ä± Al
    // (Daha Ã¶nce formun iÃ§ine {{ form.hidden_tag() }} eklediÄŸimiz iÃ§in bu deÄŸer sayfada var)
    let csrfToken = document.querySelector('input[name="csrf_token"]').value;

    document.querySelectorAll('.row-check:checked').forEach(chk => {
        let tr = chk.closest('tr');
        let rowData = JSON.parse(tr.dataset.rowData);
        
        // Checkbox'Ä± DOM'dan bul
        let checkboxEl = tr.querySelector('.save-rule-check');
        let shouldSaveRule = false;
        if (checkboxEl && checkboxEl.checked) {
            shouldSaveRule = true;
        }

        // Sadece hedefi belli olanlarÄ± listeye ekle
        if (rowData.oneri.target_id) {
            selectedRows.push({
                tarih: rowData.tarih,
                belge_no: rowData.belge_no,
                aciklama: rowData.aciklama,
                tutar: rowData.tutar,
                yon: rowData.yon,
                target_type: rowData.oneri.hedef_turu,
                target_id: rowData.oneri.target_id,
                
                // POS Verileri
                is_pos: rowData.oneri.is_pos,
                komisyon_tutari: rowData.oneri.komisyon,
                brut_tutar: rowData.oneri.brut_tutar,
                komisyon_hesap_id: rowData.oneri.komisyon_hesap_id,
                komisyon_orani: rowData.oneri.oran,
                
                // Otomatik Ã–ÄŸrenme Parametreleri
                match_source: rowData.oneri.kaynak,
                match_key: rowData.oneri.kural_anahtar,
                save_rule: shouldSaveRule
            });
        }
    });

    if (selectedRows.length === 0) {
        alert("AktarÄ±lacak geÃ§erli (eÅŸleÅŸmiÅŸ) kayÄ±t bulunamadÄ±!");
        return;
    }

    if (!confirm(`${selectedRows.length} adet iÅŸlem aktarÄ±lacak.\n("Ã–ÄŸren" seÃ§ili olanlar kural olarak kaydedilecek)`)) return;

    // 2.Fetch Ä°steÄŸine Header Ekle
    fetch('/banka-import/kaydet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken // <--- Ä°ÅžTE EKSÄ°K OLAN PARÃ‡A BU!
        },
        body: JSON.stringify({
            satirlar: selectedRows,
            banka_id: bankaId,
            file_hash: globalHash
        })
    })
    .then(async response => {
        // Hata kontrolÃ¼nÃ¼ burada yapalÄ±m ki detay gÃ¶relim
        if (!response.ok) {
            const text = await response.text();
            throw new Error(`Hata (${response.status}): ${text}`);
        }
        return response.json();
    })
    .then(res => {
        if(res.success) {
            alert(res.message);
            console.log("res.message", res.message)
            window.location.href = "/banka-hareket";
        } else {
            alert("Sunucu HatasÄ±: " + (res.error || res.message));
        }
    })
    .catch(err => {
        console.error("AktarÄ±m HatasÄ±:", err);
        // HTML hatasÄ± gelirse kullanÄ±cÄ±ya Ã¶zet geÃ§
        let msg = err.message;
        if (msg.includes("CSRF")) msg = "GÃ¼venlik hatasÄ± (CSRF).SayfayÄ± yenileyip tekrar deneyin.";
        alert("Bir sorun oluÅŸtu: " + msg);
    });
}

// YardÄ±mcÄ± FormatÃ¶rler
function formatMoney(amount) {
    return parseFloat(amount).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' â‚º';
}
function formatDate(dateStr) {
    if(!dateStr) return '-';
    let d = new Date(dateStr);
    return d.toLocaleDateString('tr-TR');
}

// TÃ¼mÃ¼nÃ¼ SeÃ§/KaldÄ±r
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.row-check').forEach(c => c.checked = this.checked);
});
</script>
{% endblock %}