{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm mb-4 no-print">
        <div class="card-body py-3">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Kasa Seçimi</label>
                    <select name="kasa_id" class="form-select select2" onchange="this.form.submit()">
                        <option value="">Kasa Seçiniz...</option>
                        {% for k in kasa_opts %}
                        <option value="{{ k.id }}" {% if k.id == secilen_kasa_id %}selected{% endif %}>
                            {{ k.ad }} ({{ k.doviz_turu.name if k.doviz_turu.name is defined else 'TL' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Başlangıç</label>
                    <input type="date" name="bas_tarih" class="form-control" value="{{ bas_tarih }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Bitiş</label>
                    <input type="date" name="bit_tarih" class="form-control" value="{{ bit_tarih }}">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Raporla</button>
                </div>
            </form>
        </div>
    </div>

    {% if secilen_kasa_id %}
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-secondary text-white shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-white-50">DEVİR (ÖNCEKİ)</h6>
                    <h3>{{ "{:,.2f}".format(devir_bakiye) }} <small class="fs-6">TL</small></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-white-50">DÖNEM GİRİŞ</h6>
                    <h3>+ {{ "{:,.2f}".format(toplam_giris) }} <small class="fs-6">TL</small></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-white-50">DÖNEM ÇIKIŞ</h6>
                    <h3>- {{ "{:,.2f}".format(toplam_cikis) }} <small class="fs-6">TL</small></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-white-50">NET BAKİYE</h6>
                    <h3>{{ "{:,.2f}".format(son_bakiye) }} <small class="fs-6">TL</small></h3>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 no-print">
        <div class="card-header bg-white">
            <h6 class="m-0 fw-bold">Bakiye Değişim Grafiği</h6>
        </div>
        <div class="card-body">
            <canvas id="bakiyeChart" height="80"></canvas>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="m-0 text-primary">{{ secilen_kasa.ad }} - Hareket Dökümü</h5>
            <button onclick="window.print()" class="btn btn-sm btn-outline-secondary no-print">
                <i class="bi bi-printer"></i> Yazdır
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 100px;">Tarih</th>
                        <th>Belge No</th>
                        <th>Açıklama</th>
                        <th class="text-end text-success">Giriş</th>
                        <th class="text-end text-danger">Çıkış</th>
                        <th class="text-end fw-bold">Bakiye</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="bg-light fw-bold text-secondary">
                        <td>{{ bas_tarih }}</td>
                        <td>DEVİR</td>
                        <td>Dönem Başı Devir Bakiyesi</td>
                        <td class="text-end">-</td>
                        <td class="text-end">-</td>
                        <td class="text-end">{{ "{:,.2f}".format(devir_bakiye) }}</td>
                    </tr>
                    
                    {% for h in hareketler %}
                    <tr>
                        <td>{{ h.tarih.strftime('%d.%m.%Y') }}</td>
                        <td><span class="badge bg-light text-dark border">{{ h.belge_no }}</span></td>
                        <td>
                            {{ h.aciklama }}
                            {% if h.cari %}<br><small class="text-muted">{{ h.cari.unvan }}</small>{% endif %}
                        </td>
                        <td class="text-end text-success">
                            {% if h.giris > 0 %}{{ "{:,.2f}".format(h.giris) }}{% endif %}
                        </td>
                        <td class="text-end text-danger">
                            {% if h.cikis > 0 %}{{ "{:,.2f}".format(h.cikis) }}{% endif %}
                        </td>
                        <td class="text-end fw-bold">{{ "{:,.2f}".format(h.yuruyen_bakiye) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light fw-bold">
                    <tr>
                        <td colspan="3" class="text-end">TOPLAMLAR:</td>
                        <td class="text-end text-success">{{ "{:,.2f}".format(toplam_giris) }}</td>
                        <td class="text-end text-danger">{{ "{:,.2f}".format(toplam_cikis) }}</td>
                        <td class="text-end">{{ "{:,.2f}".format(son_bakiye) }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info text-center py-5">
        <h4><i class="bi bi-arrow-up-circle"></i></h4>
        <p>Lütfen rapor almak istediğiniz kasayı yukarıdan seçiniz.</p>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    {% if secilen_kasa_id %}
    const ctx = document.getElementById('bakiyeChart').getContext('2d');
    
    // Jinja'dan verileri çekiyoruz
    const labels = [{% for h in hareketler %}"{{ h.tarih.strftime('%d.%m') }}",{% endfor %}];
    const dataPoints = [{% for h in hareketler %}{{ h.yuruyen_bakiye }},{% endfor %}];

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Bakiye Seyri',
                data: dataPoints,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
    {% endif %}
</script>

<style>
    /* Yazdırma ayarları: Sadece tabloyu ve başlığı göster, butonları gizle */
    @media print {
        .no-print, .sidebar, .navbar { display: none !important; }
        .card { border: none !important; shadow: none !important; }
        .table th { background-color: #f8f9fa !important; color: #000 !important; }
    }
</style>
{% endblock %}