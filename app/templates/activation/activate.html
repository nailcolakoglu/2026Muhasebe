<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yazılım Aktivasyonu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; height: 100vh; display: flex; align-items: center; }
        .activation-card { max-width: 500px; width: 100%; margin: auto; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; }
        .hwid-badge { font-family: monospace; font-size: 0.85rem; background: #e9ecef; padding: 5px 10px; border-radius: 5px; color: #495057; word-break: break-all; }
    </style>
</head>
<body>

<div class="activation-card">
    <div class="text-center mb-4">
        <h2 class="fw-bold">Aktivasyon Gerekli</h2>
        <p class="text-muted">Devam etmek için lütfen geçerli bir lisans anahtarı girin.</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="activationForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
        
        <input type="hidden" name="hwid" id="hwid">

        <div class="mb-3">
            <label class="form-label fw-bold">Lisans Anahtarı</label>
            <input type="text" name="license_key" class="form-control form-control-lg text-center shadow-sm" 
                   placeholder="XXXX-XXXX-XXXX-XXXX" required maxlength="19">
        </div>

        <div class="mb-4">
            <label class="form-label d-block text-muted small mb-1">Cihaz Kimliğiniz (Otomatik Üretilen):</label>
            <div id="hwid_display" class="hwid-badge">Kimlik hesaplanıyor...</div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 shadow">Hemen Aktive Et</button>
    </form>
    
    <div class="text-center mt-4">
        <small class="text-muted">Destek için: <a href="mailto:destek@muhasebe.local">Yöneticiye Başvurun</a></small>
    </div>
</div>

<script>
    /**
     * Tarayıcı özelliklerinden benzersiz bir kimlik üretir.
     * Bu sayede ngrok üzerinden bağlanan farklı cihazlar ayırt edilir.
     */
    function generateBrowserFingerprint() {
        const fingerprintData = [
            navigator.userAgent,          // Tarayıcı ve İşletim Sistemi
            navigator.language,           // Dil
            screen.width + "x" + screen.height, // Ekran Çözünürlüğü
            new Date().getTimezoneOffset(), // Saat Dilimi
            navigator.hardwareConcurrency // CPU Çekirdek Sayısı (varsa)
        ].join('|');

        // Basit bir hashing fonksiyonu
        let hash = 0;
        for (let i = 0; i < fingerprintData.length; i++) {
            let char = fingerprintData.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32bit integer'a dönüştür
        }
        
        // "BW-" ön eki ile benzersiz ID
        return "BW-" + Math.abs(hash).toString(16).toUpperCase();
    }

    // Sayfa yüklendiğinde çalıştır
    window.onload = function() {
        const browserID = generateBrowserFingerprint();
        document.getElementById('hwid').value = browserID;
        document.getElementById('hwid_display').innerText = browserID;
    };
</script>

</body>
</html>