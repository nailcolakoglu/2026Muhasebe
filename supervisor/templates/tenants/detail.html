{% extends 'layouts/base.html' %}

{% block title %}{{ tenant.unvan }} - Detay{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <div class="d-flex align-items-center gap-3">
            <h2 class="mb-0">{{ tenant.unvan }}</h2>
            {% if tenant.is_active %}
            <span class="badge bg-success">Aktif</span>
            {% else %}
            <span class="badge bg-secondary">Pasif</span>
            {% endif %}
        </div>
        <p class="text-muted mb-0">
            <strong>Kod:</strong> {{ tenant.kod }} | 
            <strong>Veritabanı:</strong> {{ tenant.db_name }}
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('tenants.edit', tenant_id=tenant.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-2"></i>
            Düzenle
        </a>
        <form method="POST" action="{{ url_for('tenants.toggle_status', tenant_id=tenant.id) }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-outline-{% if tenant.is_active %}warning{% else %}success{% endif %}">
                <i class="bi bi-{% if tenant.is_active %}pause-circle{% else %}play-circle{% endif %} me-2"></i>
                {% if tenant.is_active %}Dondur{% else %}Aktifleştir{% endif %}
            </button>
        </form>
        <a href="{{ url_for('tenants.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>
            Geri
        </a>
    </div>
</div>

<!-- İstatistikler -->
<div class="row g-3 mb-4">
    <!-- Kullanıcı Sayısı -->
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon primary">
                    <i class="bi bi-people"></i>
                </div>
            </div>
            <p class="stat-card-title">Kullanıcılar</p>
            <h3 class="stat-card-value">
                {{ users|length }}
                {% if active_license %}
                / {{ active_license.max_users }}
                {% endif %}
            </h3>
        </div>
    </div>
    
    <!-- Lisans Durumu -->
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon {% if active_license %}success{% else %}danger{% endif %}">
                    <i class="bi bi-key"></i>
                </div>
            </div>
            <p class="stat-card-title">Lisans</p>
            {% if active_license %}
            <h3 class="stat-card-value">{{ active_license.license_type }}</h3>
            <small class="text-muted">{{ active_license.valid_until.strftime('%d.%m.%Y') }}</small>
            {% else %}
            <h3 class="stat-card-value text-danger">Yok</h3>
            {% endif %}
        </div>
    </div>
    
    <!-- Son Aktivite -->
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon warning">
                    <i class="bi bi-clock"></i>
                </div>
            </div>
            <p class="stat-card-title">Son Aktivite</p>
            {% if extended and extended.last_activity_at %}
            <small class="text-muted">{{ extended.last_activity_at.strftime('%d.%m.%Y %H:%M') }}</small>
            {% else %}
            <small class="text-muted">-</small>
            {% endif %}
        </div>
    </div>
    
    <!-- Oluşturma Tarihi -->
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon success">
                    <i class="bi bi-calendar-check"></i>
                </div>
            </div>
            <p class="stat-card-title">Oluşturma</p>
            <small class="text-muted">{{ tenant.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info" type="button">
            <i class="bi bi-info-circle me-2"></i>Genel Bilgiler
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#users" type="button">
            <i class="bi bi-people me-2"></i>Kullanıcılar ({{ users|length }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#licenses" type="button">
            <i class="bi bi-key me-2"></i>Lisanslar ({{ licenses|length }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#activities" type="button">
            <i class="bi bi-activity me-2"></i>Aktiviteler
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#danger" type="button">
            <i class="bi bi-exclamation-triangle me-2"></i>Tehlikeli İşlemler
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Genel Bilgiler -->
    <div class="tab-pane fade show active" id="info">
        <div class="stat-card">
            <h5 class="mb-3">Firma Bilgileri</h5>
            <table class="table">
                <tbody>
                    <tr>
                        <th width="200">Firma Kodu: </th>
                        <td><strong>{{ tenant.kod }}</strong></td>
                    </tr>
                    <tr>
                        <th>Ünvan:</th>
                        <td>{{ tenant.unvan }}</td>
                    </tr>
                    <tr>
                        <th>Vergi No:</th>
                        <td>{{ tenant.vergi_no or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Vergi Dairesi:</th>
                        <td>{{ tenant.vergi_dairesi or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Veritabanı: </th>
                        <td><code>{{ tenant.db_name }}</code></td>
                    </tr>
                    <tr>
                        <th>Durum:</th>
                        <td>
                            {% if tenant.is_active %}
                            <span class="badge bg-success">Aktif</span>
                            {% else %}
                            <span class="badge bg-secondary">Pasif</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Oluşturma: </th>
                        <td>{{ tenant.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    <tr>
                        <th>Güncelleme:</th>
                        <td>{{ tenant.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="mt-3">
                <form method="POST" action="{{ url_for('tenants.update_stats', tenant_id=tenant.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        İstatistikleri Güncelle
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Kullanıcılar -->
    <div class="tab-pane fade" id="users">
        <div class="stat-card">
            <h5 class="mb-3">Kullanıcı Listesi</h5>
            
            {% if users %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Ad Soyad</th>
                            <th>Durum</th>
                            <th>Son Giriş</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.email }}</td>
                            <td>{{ user.full_name or '-' }}</td>
                            <td>
                                {% if user.is_active %}
                                <span class="badge bg-success">Aktif</span>
                                {% else %}
                                <span class="badge bg-secondary">Pasif</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.last_login %}
                                {{ user.last_login.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                <span class="text-muted">Hiç giriş yapmadı</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-4">Henüz kullanıcı yok</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Lisanslar -->
    <div class="tab-pane fade" id="licenses">
        <div class="stat-card">
            <h5 class="mb-3">Lisans Geçmişi</h5>
            
            {% if licenses %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Tip</th>
                            <th>Başlangıç</th>
                            <th>Bitiş</th>
                            <th>Kullanıcı Limiti</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for license in licenses %}
                        <tr>
                            <td><span class="badge bg-primary">{{ license.license_type }}</span></td>
                            <td>{{ license.valid_from.strftime('%d.%m.%Y') }}</td>
                            <td>{{ license.valid_until.strftime('%d.%m.%Y') }}</td>
                            <td>{{ license.max_users }}</td>
                            <td>
                                {% if license.is_active %}
                                <span class="badge bg-success">Aktif</span>
                                {% else %}
                                <span class="badge bg-secondary">Pasif</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-4">Henüz lisans yok</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Aktiviteler -->
    <div class="tab-pane fade" id="activities">
        <div class="stat-card">
            <h5 class="mb-3">Son Aktiviteler</h5>
            
            {% if recent_activities %}
            <div class="list-group list-group-flush">
                {% for activity in recent_activities %}
                <div class="list-group-item px-0">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="{{ activity.action_icon }} fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>{{ activity.action }}</strong>
                                <small class="text-muted">{{ activity.created_at.strftime('%d.%m %H:%M') }}</small>
                            </div>
                            <small class="text-muted">{{ activity.description }}</small>
                            <br>
                            <small class="text-muted">
                                <i class="bi bi-person me-1"></i>{{ activity.supervisor_username }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center py-4">Henüz aktivite yok</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Tehlikeli İşlemler -->
    <div class="tab-pane fade" id="danger">
        <div class="stat-card">
            <h5 class="text-danger mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Tehlikeli İşlemler
            </h5>
            
            <div class="alert alert-danger">
                <strong>Uyarı!</strong> Bu işlemler geri alınamaz.Dikkatli olun! 
            </div>
            
            <!-- Firma Silme -->
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-danger">Firmayı Sil</h6>
                    <p class="card-text">
                        Bu firma ve tüm ilişkili verileri (kullanıcılar, lisanslar, loglar) kalıcı olarak silinecektir.
                    </p>
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash me-2"></i>
                        Firmayı Kalıcı Olarak Sil
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Silme Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Firmayı Sil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('tenants.delete', tenant_id=tenant.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>DİKKAT!</strong> Bu işlem geri alınamaz! 
                    </div>
                    
                    <p>
                        <strong>{{ tenant.unvan }}</strong> firması ve tüm verileri kalıcı olarak silinecektir.
                    </p>
                    
                    <p>Devam etmek için firma kodunu yazın:  <code>{{ tenant.kod }}</code></p>
                    
                    <input type="text" 
                           name="confirmation" 
                           class="form-control" 
                           placeholder="Firma kodunu yazın"
                           required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>
                        Evet, Sil
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}